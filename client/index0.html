<!DOCTYPE html>
<html>
 <head>
   <meta charset="utf-8"/>
      <style>
      </style>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.1/p5.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.1/addons/p5.dom.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js"></script>
 </head>
 <body>
  <section id="textOutput-content"></section>
<script type="text/javascript">

var data = {
  "path": [
    {
      "x": 661,
      "y": 380
    },
    {
      "x": 661,
      "y": 381
    },
    {
      "x": 661,
      "y": 381
    },
    {
      "x": 661,
      "y": 383
    },
    {
      "x": 661,
      "y": 387
    },
    {
      "x": 661,
      "y": 393
    },
    {
      "x": 666,
      "y": 399
    },
    {
      "x": 671,
      "y": 403
    },
    {
      "x": 674,
      "y": 404
    },
    {
      "x": 683,
      "y": 405
    },
    {
      "x": 689,
      "y": 405
    },
    {
      "x": 693,
      "y": 404
    },
    {
      "x": 697,
      "y": 396
    },
    {
      "x": 697,
      "y": 371
    },
    {
      "x": 697,
      "y": 350
    },
    {
      "x": 686,
      "y": 323
    },
    {
      "x": 671,
      "y": 303
    },
    {
      "x": 647,
      "y": 285
    },
    {
      "x": 620,
      "y": 272
    },
    {
      "x": 591,
      "y": 265
    },
    {
      "x": 571,
      "y": 264
    },
    {
      "x": 537,
      "y": 264
    },
    {
      "x": 522,
      "y": 268
    },
    {
      "x": 505,
      "y": 277
    },
    {
      "x": 496,
      "y": 288
    },
    {
      "x": 492,
      "y": 299
    },
    {
      "x": 490,
      "y": 319
    },
    {
      "x": 502,
      "y": 353
    },
    {
      "x": 511,
      "y": 366
    },
    {
      "x": 547,
      "y": 408
    },
    {
      "x": 576,
      "y": 427
    },
    {
      "x": 606,
      "y": 439
    },
    {
      "x": 639,
      "y": 444
    },
    {
      "x": 659,
      "y": 444
    },
    {
      "x": 677,
      "y": 440
    },
    {
      "x": 688,
      "y": 434
    },
    {
      "x": 693,
      "y": 427
    },
    {
      "x": 694,
      "y": 420
    },
    {
      "x": 694,
      "y": 415
    },
    {
      "x": 692,
      "y": 411
    },
    {
      "x": 689,
      "y": 407
    },
    {
      "x": 686,
      "y": 404
    },
    {
      "x": 682,
      "y": 400
    },
    {
      "x": 678,
      "y": 396
    },
    {
      "x": 676,
      "y": 392
    },
    {
      "x": 670,
      "y": 386
    },
    {
      "x": 663,
      "y": 380
    },
    {
      "x": 653,
      "y": 376
    },
    {
      "x": 640,
      "y": 371
    },
    {
      "x": 626,
      "y": 367
    },
    {
      "x": 613,
      "y": 365
    },
    {
      "x": 608,
      "y": 364
    },
    {
      "x": 605,
      "y": 363
    },
    {
      "x": 604,
      "y": 363
    },
    {
      "x": 603,
      "y": 364
    },
    {
      "x": 602,
      "y": 373
    },
    {
      "x": 602,
      "y": 393
    },
    {
      "x": 606,
      "y": 422
    },
    {
      "x": 614,
      "y": 444
    },
    {
      "x": 623,
      "y": 466
    },
    {
      "x": 627,
      "y": 477
    },
    {
      "x": 630,
      "y": 490
    },
    {
      "x": 629,
      "y": 495
    },
    {
      "x": 617,
      "y": 496
    },
    {
      "x": 589,
      "y": 485
    },
    {
      "x": 565,
      "y": 458
    },
    {
      "x": 535,
      "y": 418
    },
    {
      "x": 518,
      "y": 392
    },
    {
      "x": 508,
      "y": 377
    },
    {
      "x": 501,
      "y": 368
    },
    {
      "x": 499,
      "y": 364
    },
    {
      "x": 498,
      "y": 363
    },
    {
      "x": 499,
      "y": 363
    },
    {
      "x": 506,
      "y": 363
    },
    {
      "x": 526,
      "y": 363
    },
    {
      "x": 537,
      "y": 363
    },
    {
      "x": 642,
      "y": 210
    },
    {
      "x": 640,
      "y": 210
    },
    {
      "x": 635,
      "y": 214
    },
    {
      "x": 631,
      "y": 221
    },
    {
      "x": 628,
      "y": 226
    },
    {
      "x": 626,
      "y": 234
    },
    {
      "x": 626,
      "y": 241
    },
    {
      "x": 626,
      "y": 247
    },
    {
      "x": 631,
      "y": 252
    },
    {
      "x": 639,
      "y": 257
    },
    {
      "x": 650,
      "y": 264
    },
    {
      "x": 666,
      "y": 272
    },
    {
      "x": 679,
      "y": 280
    },
    {
      "x": 690,
      "y": 287
    },
    {
      "x": 696,
      "y": 291
    },
    {
      "x": 702,
      "y": 296
    },
    {
      "x": 705,
      "y": 299
    },
    {
      "x": 707,
      "y": 301
    },
    {
      "x": 709,
      "y": 302
    },
    {
      "x": 709,
      "y": 303
    },
    {
      "x": 709,
      "y": 303
    }
  ]
}

class Bicho {
  constructor(xpos, ypos, nodes, limbs, spacing, color, spring, damp, curve, radius, rotAngle, json){
    this.x = xpos;
    this.y = ypos;
    this.vx = 0;
    this.vy = 0;
    this.ax = 0;
    this.ay = 0;
    this.nodes = nodes;
    this.limbs = limbs;
    this.spacing = spacing;
    this.color = color;
    this.spring = spring;
    this.damp = damp;
    this.curve = curve;
    this.nodeX = new Array(this.nodes).fill(0);
    this.nodeY = new Array(this.nodes).fill(0);
    this.angle = new Array(this.nodes).fill(0);
    this.jitter = new Array(this.nodes).fill(0);
    this.radius = radius;
    this.rotAngle = rotAngle;
    this.json = json;
    for(let i=0; i<this.jitter.length; i++) {
      this.jitter[i] = random(0.9, 1.1);
    }

    this.accel = function () {
      this.ax = (mouseX-this.x)*0.5;
      this.ay = (mouseY-this.y)*0.5;
      //springing effect
      this.ax *= this.spring;
      this.ay *= this.spring;
    }

    this.vel = function () {
      this.vx += this.ax;
      this.vy += this.ay;
    }

    this.moveCentre = function() {
      this.x += this.vx;
      this.y += this.vy;

      for (var i=0; i<this.nodes; i++){
        this.nodeX[i] = this.x+cos(radians(this.rotAngle))*this.radius +sin(radians(this.angle[i]));//*(this.vx*0.1);
        this.nodeY[i] = this.y+sin(radians(this.rotAngle))*this.radius +sin(radians(this.angle[i]));//*(this.vy*0.1);
        this.rotAngle += 360.0/this.nodes;
        this.angle[i] *= this.jitter[i];
      }
    }

    // slow down bicho
    this.friction = function() {
      this.vx *= this.damp;
      this.vy *= this.damp;
    }

    this.moveNodes = function() {
     this.accel();
     this.vel();
     this.friction();
     this.moveCentre();
    }

    this.drawWave = function(offsetX, offsetY, rate, j) {
      // change curve tightness
       curveTightness(this.curve);
       fill(this.color);

       beginShape();
       let spacer = 0;

       for (var i=0; i < this.nodes; i++){
         spacer += i;
         curveVertex(
           //x
           (
             this.nodeX[i]+ this.json[i+j].x + offsetX + 0.4*100*
             sin(this.nodeX[i]*(rate+PI/this.nodes))
                  ),
           //y
           (
             this.nodeY[i]+ this.json[i+j].y + offsetY + 0.4*100*
             cos(this.nodeY[i]*(rate+PI/this.nodes))
                  )
         );
       }
       endShape(CLOSE);
    }
    this.drawBicho = function() {
      this.curve = 0.5-((abs(this.vx)+abs(this.vy))*0.1);

      for(var i=0; i<this.limbs; i++){
        this.drawWave(i*this.spacing, i*this.spacing, i*0.01, i);
      }
    }
  }
}

var crichure;
// Get input from user
var points = [];
var r, g, b;
var inc = 0;
// var data;
// var jsonfiles = ["assets/critter1.json", "assets/critter4.json", "assets/critter5.json"];
// var string = jsonfiles[Math.floor(Math.random()*jsonfiles.length)];
// console.log(string);

// function preload() {
//   data = loadJSON(string);
// }

function setup() {
  var tareX = data.path[0].x;
  var tareY = data.path[0].y;
  for(let i=0; i<data.path.length; i++) {
    data.path[i].x -= tareX;
    data.path[i].y -= tareY;
  }

 let canvas = createCanvas(1200, 800);

 canvas.class("lemon");

 noStroke();
 frameRate(30);

 crichure = new Bicho(
   width/2, //inital x pos
   height/2, //inital y pos
   37, //curve nodes
   5, //limbs
   5, //limb spacing scalar
   random(["#7d22ff", '#e87de3', '#285afc', '#e05364']), //color
   0.005, //springing coefficient
   0.9, //damping coefficient
   1.0, //curvature coefficient
   23, //radius
   0, //rotational angle
   data.path// local_data //json array
 );

 canvas.mousePressed(startDrawing);
 canvas.mouseReleased(endDrawing);

 r = random(255);
 g = random(255);
 b = random(255);
}


function draw() {
   background(55, 232,192)
   /* fade background */
   fill(0, 0);
   rect(0,0,width, height);

   crichure.moveNodes();
   crichure.drawBicho();

  //render users drawing//render users drawing//render users drawing
   noStroke();
   fill(r,g,b);

   beginShape();
   for (var i = 0; i < points.length; i++) {
     vertex(points[i].x + 20*sin(inc*i*PI/points.length), points[i].y + 20*cos(inc*i*PI/points.length));
   }
   endShape();
   inc+=0.1;
   //render users drawing//render users drawing//render users drawing
}


////DRAWING FUNCTIONS////DRAWING FUNCTIONS////DRAWING FUNCTIONS////DRAWING FUNCTIONS
function startDrawing() {
  // Empty array
  points = [];
}

// Put points in the array
function mouseDragged() {
  var p = {
    x: mouseX,
    y: mouseY
  }
  points.push(p);
  // console.log(points);
}

// Finished send data!
function endDrawing() {
  var dat = {
    path: points
  };

  $.post('/drawing', dat, function(dat, status, jqXHR){
    console.log(dat);
  });
  // saveJSON(dat, 'critter.json');
}
////DRAWING FUNCTIONS////DRAWING FUNCTIONS////DRAWING FUNCTIONS////DRAWING FUNCTIONS


</script>
      <div id="floatdiv" style="overflow:auto;">
        <p class="noselect"></p>
        </div>
 </body>
</html>
