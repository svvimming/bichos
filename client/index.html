<!DOCTYPE html>
<html>
 <head>
   <meta charset="utf-8"/>
      <style>
      </style>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.1/p5.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.1/addons/p5.dom.min.js"></script>
   <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.js"></script>
 </head>
 <body>
  <section id="textOutput-content"></section>
  <script type="text/javascript" src="js/pathnames.js"></script>
  <script type="text/javascript" src="js/colorspace.js"></script>
  <script type="text/javascript" src="js/bichos.js"></script>
<script type="text/javascript">

var crichure;
var temp_data;
var canvas_width = 1200;
var canvas_height = 800;
// Get input from user
var points = [];
var hue_init, hue, gray_init, gray, lgt;
var inc = 0;
var inc2 = 0;
var step = 0.1;
var gate = false;
var done = false;
var donedrawing = false;
var submitted = false;
var motion = 0;
var dummyX, dummyY;

var limb_nodes = 37;
var limbs = 5;
var canvas;

function setup() {
 canvas = createCanvas(canvas_width, canvas_height);
 canvas.id("lemon");
 canvas.mouseReleased(endDrawing);

 noStroke();
 frameRate(30);

 hue_init = floor(random(0, 360));
 gray_init = 75;
 lgt = gray_init-11;
 hue = hue_init;
 gray = gray_init;

 get_json_path_name();
}

function createBicho() {
  crichure = new Bicho(
    canvas_width/2, //inital x pos
    canvas_height/2, //inital y pos
    limb_nodes, //curve nodes
    limbs, //limbs
    5, //limb spacing scalar
    temp_data.color,
    0.005, //springing coefficient
    0.9, //damping coefficient
    1.0, //curvature coefficient
    23, //radius
    0, //rotational angle
    temp_data.path// local_json_data //json array
  );
  gate = true;
}

function draw() {
   background(55, 232,192)
   /* fade background */
   fill(0, 0);
   rect(0,0,canvas_width, canvas_height);

   if(gate){
     crichure.moveNodes();
     crichure.drawBicho();
   }
   if(donedrawing && !submitted){
      varyColor();
   }
   //render users drawing//render users drawing//render users drawing
   noStroke();
   fill('hsl('+hue+', '+gray+'%, '+lgt+'%)');
   var spin = 10*sin(inc*PI/points.length);

   beginShape();
   for (var i = 0; i < points.length; i++) {
     vertex(points[i].x + motion*20*sin(spin*i*PI/points.length), points[i].y + motion*20*cos(spin*i*PI/points.length));
   }
   endShape();
   inc+=step;
   if (submitted){
     disappear();
   }
   //render users drawing//render users drawing//render users drawing
}

function varyColor() {
    hue = (abs(hue_init + floor((mouseX-dummyX)*(360/canvas_width))) % 360);
    gray = Math.min(abs(gray_init + floor((mouseY-dummyY)*(100/canvas_height))), 100);
    lgt = Math.max(gray - 11, 0);
}

function disappearance() {
  step = 5;
  submitted = true;
  done = true;
}
function disappear() {
  var scale = 1.01-(0.01*inc2);
  for(var i=0; i<points.length; i++) {
    points[i].x *= scale;
    points[i].y *= scale;
    motion *= scale;
  }
  inc2+=0.1;
}


function mousePressed() {
  if(!done){
    if (!donedrawing) {
      startDrawing();
    } else if (!submitted) {
      submitDrawing();
    }
  }
}

////DRAWING FUNCTIONS////DRAWING FUNCTIONS////DRAWING FUNCTIONS////DRAWING FUNCTIONS
function startDrawing() {
  // Empty array
  motion = 0;
  points = [];
}

// Put points in the array
function mouseDragged() {
  if(!done){
    var p = {
      x: mouseX,
      y: mouseY
    }
    points.push(p);
  }
}

// Finished send data!
function endDrawing() {
  motion = 1;
  donedrawing = true;
  dummyX = mouseX;
  dummyY = mouseY;
}

function submitDrawing() {
  if (500<points.length) {
    var blob = points.splice(0, points.length-500);
  } else {
    var blob = points;
  }
  var rgb = HSLToRGB(hue, gray, lgt);
  var hex = rgbToHex(rgb[0], rgb[1], rgb[2]);
  console.log(hex);
  if ((limb_nodes+limbs)<points.length) {
    var data = {
      color: hex,
      path: blob
    };
    $.post('/drawing', data, function(data, status, jqXHR){
      console.log(data);
    });
    disappearance();
  }
}
////DRAWING FUNCTIONS////DRAWING FUNCTIONS////DRAWING FUNCTIONS////DRAWING FUNCTIONS

</script>
      <div id="floatdiv" style="overflow:auto;">
        <p class="noselect"></p>
        </div>
 </body>
</html>
